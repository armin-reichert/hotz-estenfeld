\section{The theorem of Chomsky-Schützenberger}

The Chomsky-Schützenberger theorem is one of the fundamental theorems in the
theory of formal languages, especially the context-free languages \cite{ChSch}.

In the literature, the proof of this theorem is always based on grammars.

We will give an automata-theoretic access to this theorem. We present this
theorem at this point in the book because from a proof technical point of
view it can very well be appended to the section on pushdown languages
(chapter III.1). A similar access to this theorem has been given by Goldstine
 \cite{Goldstine77,Goldstine79,Goldstine80}.

The Chomsky-Schützenberger theorem characterizes the context-free languages
by a very simple subclass of context-free languages with the use of a
homomorphism.

In this respect the theorem is an analogon to lemma 7 in chapter II.1 where we
proved that each regular language can be presented as the homomorphic image of
a local language.

We want to formulate the theorem now.

Let $D(\Sigma)$ be the Dyck language over the alphabet $\Sigma$ (see chapter
I.3, page \pageref{dyck-language}).

Remark: In the literature, often the language \[ \setof{w\in
(\unioninv{\Sigma})^* \mid |w|= \epsilon\text{ in the free group }F(\Sigma)} \]
is called Dyck language. We denote that language as the {\em symmetric} Dyck
language.

With our notations the following theorem holds:
\begin{theorem}[Chomsky-Schützenberger] For each language $L\in \alglang(X^*)$
there exists
\begin{itemize}
  \item an alphabet $\Sigma \subset X_\infty$
  \item a regular set $R\in \reglang((\unioninv{\Sigma})^*)$
  \item and a monoid homomorphism $\phi: (\unioninv{\Sigma})^* \to X^*$ such
  that
\end{itemize}
\[ L = \phi(D(\Sigma)\cap R) \]
\end{theorem}

(The proof in the original book was hard to read, it has been reformulated
therefore.)

\begin{proof}
$L\in \alglang(X^*) \Rightarrow$ it exists a PDA $\kappa=(\fa{A},\storage{K})$ with
$L = L_\kappa$, where $\fa{A}=(G, X, S, F, \alpha)$ is the corresponding finite
automaton and $G=(V, E)$ the graph of $\fa{A}$.

For the proof we use the graph $G'=(V',E'),\ V' = V \cup \setof{s_0}$, which we
constructed in theorem 2 of section III.1 and the mapping $\gamma: E' \to 
\hgroup{Y}$.

Reminder: The graph $G'$ was constructed from $G$ by adding the following kinds
of edges:
\begin{itemize}
  \item A start edge $e_0 \in \setof{s_0} \times S$ of the form 
  \[e_0: s_0 \edge{y_0} s\] 
  for each start vertex $s \in S$.
  
  \item ''PUSH''-edges $e'=(e, y) \in E \times Y$ of the form
  \[e': Q(e) \edge{y^{-1} y z} Z(e)\]
  for each edge $e \in E$ where the pushdown store computation ''pushes'' $z$,
  i.e.\ $\delta(e, y) = yz$ and $|yz| \neq \epsilon$. 
  
  The prefix $y^{-1} y$ realizes the non-deterministic guess of the topmost
  stack symbol $y$.
  
  \item ''Empty-stack''-edges $e'=(e, y) \in E \times Y$ of the form
  \[e': Q(e) \edge{y_0^{-1} y_0 \cdot \delta(e, \epsilon)} Z(e)\]
  for each edge $e \in E$.
  
  The prefix $y_0^{-1} y_0$ realizes the non-deterministic guess of the
  empty-stack symbol $y_0$.
  
  \item ''POP''-edges $e'=(e, y, z) \in E \times Y \times Y_0$ of the form
  \[e': Q(e) \edge{y^{-1} z^{-1} z} Z(e)\]
  for each edge $e \in E$ where the pushdown store ''pops'' $y$ from the stack,
  i.e.\ $\delta(e, y) = \epsilon$.
  
  The suffix $z^{-1} z$ realizes the non-deterministic guess of the topmost
  stack symbol $z$ after the ''pop'' has been executed.
\end{itemize}

Our goal is to construct a graph $\tilde{G}$ whose edges constitute the alphabet
$\Sigma \cup \Sigma^{-1}$ of corresponding brackets.

We define a relation $\rho$ on the edge set $E'$ which relates two edges if they
execute corresponding push/pop-operations.

Formally, the relation $\rho \subset E' \times E'$ is defined as follows: For
edges $e', f' \in E'$
\[ e' \,\rho\, f' \iff e' = (e, y)\text{ with }\delta(e, y) = y z,\quad f' = (f,
z, y),\quad e, f \in E,\ y,z \in Y \]

Consider a path in the graph $G$:

\begin{center}
\input{figures/chapter3-3-theorem1-path-in-g.tikz}
\end{center}

The corresponding path in the graph $G'$:

\begin{center}
\input{figures/chapter3-3-theorem1-path-in-gprime.tikz}
\end{center}

The relation $\rho$ between the edges of $G'$ can be visualized as a bipartite
graph:

\begin{center}
\input{figures/chapter3-3-theorem1-bipartite-1.tikz}
\end{center}

Edges in this relation graph connect edges representing ''opening
brackets'' (push-operations) with edges representing corresponding ''closing
brackets'' (pop-operations).

To get a one-to-one relation, the edges of $\rho$ are multiplied (if
needed). This defines a new relation $\rho'$ in which each opening bracket
has a unique closing bracket:

\begin{center}
\input{figures/chapter3-3-theorem1-bipartite-2.tikz}
\end{center}

The edges that are created from an edge $e$ by multiplying are called {\em
parallel edges} of $e$.

For edges $(e, f) \in \rho'$ we also write $f = \inv{e}$ and call $f$
the {\em inverse edge} to $e$.

In the graph $\tilde{G}$ to be constructed we replace the edges of $G'$ by their
parallel edges:

\begin{center}
\input{figures/chapter3-3-theorem1-parallel-edges.tikz}
\end{center}

A parallel edge $e^{(i)}$ has the same source and target as the original
edge $e \in G'$:
\[ Q(e^{(i)}) = Q(e),\quad Z(e^{(i)}) = Z(e) \]

By our construction it holds:
If $(e, f) \in \rho$ then there exists exactly one pair of parallel edges
$(e', f')  \in \rho'$ such that $f' = \inv{e'}$.

From the graph $G'$ we construct the graph $\tilde{G} = (\tilde{V}, \tilde{E})$
by
\begin{eqnarray*}
\tilde{V} &=& V' \ (=V \cup \setof{s_0}) \\
\tilde{E} &=& \setof{f \mid f\text{ is the parallel edge for some $e \in E'$}}
\end{eqnarray*}

If $f \in \tilde{E}$ is the parallel edge for some $e \in E'$ we write $e =
\proj{f}$ ($e$ is the {\em projection} of $f$). 

For each path $\tilde{\pi} \in \pathcat{\tilde{G}}$ it then holds
$\proj{\tilde{\pi}} \in \pathcat{G'}$ which means that each path using parallel
edges is projected to a path of original edges in $G'$.

We define the set of {\em valid} paths in $\tilde{G}$ by
\begin{eqnarray*}
R &=& \{ e_1 \circ \ldots \circ e_k \in \pathcat{\tilde{G}} \mid e_i \in
\tilde{E} \\
& & \text{and for each pair }(e_i, e_{i+1})\text{ of consecutive edges holds:}\\
& & \gamma(\proj{e_i} \circ \proj{e_{i+1}}) \not\equiv 0\text{ in the
polycyclic monoid }\pocymon{Y} \}
\end{eqnarray*} 

The path set $R$ contains exactly those paths in $\tilde{G}$ whose projections
in $G'$ have valid local pushdown store computations.

We define the set of {\em valid accepting} paths in $\tilde{G}$ by
\begin{equation*}
R' = \setof{\pi \in R \mid Q(\pi) \in S,\ Z(\pi) \in F} \subset R
\end{equation*}

Note that $R$ and $R'$ both are {\em local} sets.

We define the alphabet $\Sigma$ as those (parallel) edges that are projected to
edges in $G'$ performing a push-operation:
\begin{equation*}
\Sigma := \tilde{E}^+ := \setof{e \in \tilde{E} \mid \proj{e} =
\underbrace{(e,y)}_{\text{''PUSH''}-edge}}
\end{equation*}

Then the edge set of $\tilde{G}$ is $\tilde{E} = \tilde{E}^+ \cup
\tilde{E}^-$.

To prove the theorem we need the following lemmata which describe the
relation between accepting paths in $\tilde{G}$ and $G'$.

Let's call a path from $G'$ {\em well-nested} if it can be
reduced to the empty path using the relations
\[ e\circ \inv{e} = \epsilon,\quad e, \inv{e} \in E' \]
In the same way we define well-nested paths in the graph $\tilde{G}$.

\begin{lemma}
If $\tilde{\pi} \in R$ is a valid, well-nested, non-empty path in
$\tilde{G}$ then for the projected path $\pi = \proj{\tilde{\pi}}$ holds:
\[ |\gamma(\pi)| = y \inv{y}\text{ for some }y \in Y \]
\end{lemma}

(The lemma has been reformulated for better readability.)
\begin{proof}
The proof is done by induction over the path length. Observe that a well-nested
path has even length, therefore a well-nested non-empty path has length at least
two.

Remember the definition of the Dyck language $D(\Sigma)$ over an alphabet
$\Sigma$:
\begin{eqnarray*}
d \in D(\Sigma) &\Rightarrow& e \cdot d \cdot \inv{e} \in D(\Sigma)\text{ for
each }e \in \Sigma \\
d_1, d_2 \in D(\Sigma) &\Rightarrow& d_1 \cdot d_2 \in D(\Sigma)
\end{eqnarray*}

{\em Induction base:} $\len{\tilde{\pi}}=2$
\begin{eqnarray*}
\tilde{\pi} = e \cdot \inv{e} &\Rightarrow& (e, \inv{e}) \in \rho' \\
&\Rightarrow& (\proj{e}, \proj{\inv{e}}) \in \rho \\
&& \text{where }\proj{e} \in E \times Y\text{ is a ''push''-edge} \\
&& \text{and }\proj{\inv{e}} \in E \times Y \times Y_0\text{ is the
corresponding ''pop''-edge}
\end{eqnarray*}

$\proj{\tilde{\pi}} = \proj{e} \cdot \proj{\inv{e}}$. Let
\begin{eqnarray*}
\gamma(\proj{e}) &=& \inv{y} y z \qquad\text{(''guess $y$;\ push $z$'')} \\
\gamma(\proj{\inv{e}}) &=& \inv{z} \inv{y} y \qquad\text{(''pop $z$;\ guess
$y$'')}
\end{eqnarray*}

Then
\begin{eqnarray*}
|\gamma(\proj{\tilde{\pi}})| &=& |\gamma(\proj{e}) \cdot \gamma(\proj{\inv{e}})|
\\
&=& |\inv{y} y z \cdot \inv{z} \inv{y} y| \\
&=& |\inv{y} y| \\
&=& \inv{y} y
\end{eqnarray*}

\medskip
{\em Induction step:}

{\em Case 1:} Let the claim be true for a well-nested path $\tilde{\pi}$. Then
$|\tilde{\pi}| = \epsilon$ and for the projection of $\tilde{\pi}$ it holds
\[ |\gamma(\proj{\tilde{\pi}})| = \inv{y_1} \cdot y_1\text{ for some }y_1 \in Y
\]

Let $e \cdot \tilde{\pi} \cdot \inv{e} \in R$ be a well-nested, valid path. Then
$|e \cdot \tilde{\pi} \cdot \inv{e}| = \epsilon$.

Consider the projection
\[ \proj{e \cdot \tilde{\pi} \cdot \inv{e}} = \proj{e} \cdot \proj{\tilde{\pi}}
\cdot \proj{\inv{e}} \in \pathcat{G'} \]
where
\begin{eqnarray*}
\proj{e} &=& (e_1, z) \qquad\text{''push $z$-edge''}\\
\proj{\inv{e}} &=& (e_2, z, y) \qquad\text{''pop $z$-edge''}\\
\end{eqnarray*}
This gives
\begin{eqnarray*}
|\gamma(\proj{e} \cdot \proj{\tilde{\pi}} \cdot \proj{\inv{e}})|&=&
|\gamma(\proj{e}) \cdot \gamma(\proj{\tilde{\pi}}) \cdot \gamma(\proj{\inv{e}})|
\\
&=&|\gamma((e_1, z)) \cdot  (\inv{y_1} y_1) \cdot \gamma((e_2, z, y))| \\
&=& |(\inv{y} \cdot y \cdot z) \cdot (\inv{y_1} \cdot y_1) \cdot (\inv{z} \cdot
\inv{y} \cdot y)| \\
\end{eqnarray*}
Because $e \cdot \tilde{\pi} \cdot \inv{e}$ is well-nested, it must hold
$z = y_1$. Otherwise we had $z \cdot \inv{y_1} \equiv 0$ and therefore $e \cdot
\tilde{\pi} \cdot \inv{e} \equiv 0$ which would be a contradiction to our
assumption.

Therefore
\begin{eqnarray*}
|(\inv{y} \cdot y \cdot z) \cdot (\inv{y_1} \cdot y_1) \cdot (\inv{z} \cdot
\inv{y} \cdot y)| &=&
|(\inv{y} \cdot y \cdot z) \cdot (\inv{z} \cdot z) \cdot (\inv{z} \cdot
\inv{y} \cdot y)| \\
&=& |\inv{y} \cdot (y \cdot (z \cdot \inv{z}) \cdot (z \cdot \inv{z}) \cdot
\inv{y}) \cdot y| \\
&=& |\inv{y} \cdot y| \\
&=& \inv{y}  \cdot y
\end{eqnarray*}

\medskip
{\em Case 2:} Let $R \ni \tilde{\pi} = \tilde{\pi}_1 \cdot \tilde{\pi}_2$ be a
valid, well-nested path which is the product of two well-nested paths, i.e.\
$|\tilde{\pi}_1| = |\tilde{\pi}_2| = \epsilon$.

Consider 
\begin{eqnarray*}
|\gamma(\proj{\tilde{\pi}})| &=& |\gamma(\proj{\tilde{\pi}_1 \cdot
\tilde{\pi}_2})| \\
&=& |\gamma(\proj{\tilde{\pi}_1}) \cdot \gamma(\proj{\tilde{\pi}_2})| \\
&=& (\inv{y_1} \cdot y_1) \cdot (\inv{y_2} \cdot y_2),\ y_1, y_2 \in
Y\qquad\text{by induction}
\end{eqnarray*}

Because $\tilde{\pi}_1 \cdot \tilde{\pi}_2 \in R$ is well-nested, it must hold
$y_1 = y_2$. Otherwise $y_1 \cdot \inv{y_2} \equiv 0$ which would contradict our
 assumptions.

Therefore we get
\begin{eqnarray*}
|\gamma(\proj{\tilde{\pi}})| &=& (\inv{y_1} \cdot y_1) \cdot (\inv{y_2} \cdot
y_2)\\
&=& \inv{y_1} \cdot y_1 \cdot \inv{y_1} \cdot y_1 \\
&=& \inv{y_1} \cdot y_1
\end{eqnarray*}
\end{proof}

We assumed the path $\tilde{\pi}$ to be valid, i.e.\ $\tilde{\pi} \in R$.
Therefore the lemma also holds for valid, well-nested {\em accepting} paths
$\tilde{\pi} \in R',\ |\tilde{\pi}| = \epsilon$. Therefore for the
projection $\pi = \proj{\tilde{\pi}} \in \pathcat{G'}(S, F)$ holds
\[ |\gamma(\pi)| = \inv{y_0} y_0 \]

\bigskip
\begin{lemma}
For each path $\pi \in \pathcat{G'}$ with
\[ |\gamma(\pi)| = \inv{y} y \quad\text{for some }y \in Y \]
there exists exactly one path $\tilde{\pi} \in \pathcat{\tilde{G}} \cap R$ with
\[ |\tilde{\pi}| = \epsilon\text{ and }\pi = \proj{\tilde{\pi}} \] 
\end{lemma}

\begin{proof}
TODO
\end{proof}

Similar as after lemma 1 one can conclude that for each path $\pi \in
\pathcat{G'}(S, F)$ with $|\gamma(\pi)| = \inv{y_0}y_0$ there exists exactly one
path $\tilde{\pi} \in \pathcat{\tilde{G}}(S, F) \cap R'$ with
$\proj{\tilde{\pi}} = \pi$ and $|\tilde{\pi}| = \epsilon$.

From both lemmata the proof of the theorem follows:
\begin{eqnarray*}
L_\kappa &=& \setof{\alpha(\pi) \mid \pi \in \pathcat{G}(S, F),\ \delta(\pi,
\epsilon) = \epsilon}\text{ (by definition)} \\
&=& \setof{\alpha(\pi) \mid \pi \in \pathcat{G'}(s_0, F),\ |\gamma(\pi)| =
y_0}\text{ (by theorem 2, chapter III.1)} \\
&=& \setof{\alpha(\pi) \mid \pi \in \pathcat{G'}(S, F),\
|\gamma(\pi)| = \inv{y_0} y_0}\text{ (by construction of $G'$)}
\end{eqnarray*}

If we define $\tilde{R} := \pathcat{G}(S, F) \cap R'$, we get $\tilde{R} \in
\reglang(\unioninv{\Sigma})^*$ because the intersection of regular (local)
languages is a regular (local) language.

Together with lemma 1 and lemma 2 it follows
\[ \proj{\tilde{R} \cap D(\underbrace{\tilde{E}^+}_{\Sigma})} = \setof{\pi \in
\pathcat{G'}(s_0, F) \mid |\gamma(\pi)| = y_0} \]

With homomorphism $\phi := \mathrm{proj} \circ \alpha : (\unioninv{\Sigma})^*
\to X^*$ we finally get
\[ L_\kappa = \phi(D(\Sigma) \cap \tilde{R}) \]
\end{proof}

We even proved slightly more: Let 
\[ {<}\kappa, w{>} := \card{\setof{\pi \in
\pathcat{G}(S,F) \mid \alpha(\pi) = w,\ \delta(\pi, \epsilon) = \epsilon}}
\]
be the number of accepting computations of the PDA $\kappa$ for the word $w$.

\begin{corollary}
For each PDA $\kappa$ there exists a Dyck language $D(\Sigma)$ and a local set
$R$ over $\unioninv{\Sigma}$ and a monoid homomorphism $\phi:
(\unioninv{\Sigma})^* \to X^*$ such that
\begin{enumerate}
  \item $\phi(D(\Sigma\cap R)) = L_\kappa$
  \item For $w\in X^*$ it holds ${<}\kappa, w{>} = \card{\phi^{-1}(w)}$
\end{enumerate}
\end{corollary}

\begin{proof}\ 

\begin{enumerate}
  \item Chomsky-Schützenberger theorem
  \item Follows from the construction in the proof. (The inverse homomorphism
  gives the different accepting computations for a word.)
\end{enumerate}
\end{proof}

Problem: Is it possible to always find a PDA $\kappa$ accepting 
$L \in \alglang(X^*)$ such that for each word $w$ it holds 
${<}\kappa, w{>} < \infty$?

If the definition of the pushdown store is generalized such that $\delta(X
\times Y) \subset Y^*$ is allowed, is then the condition ${<}\kappa, w{>} <
\infty$ always satisfiable?

This problem will be investigated in a later chapter.

\medskip
At the end of this section, for interested readers we want to mention the
following:

The Dyck language $D(X) \in \alglang(X_\infty^*)$ is algebraic.

By theorem 1 in section III.2 it holds that the class of algebraic languages is
closed under monoid homomorphism, and by theorem 3 in chapter III.2 also closed
under intersection with regular sets.

From the Chomsky-Schützenberger theorem therefore follows that the class of
algebraic languages over the alphabet $X_\infty$ is exactly the class of
context-free languages.
